# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  aws-cli: circleci/aws-cli@2.0

jobs:
  Lint-js-files:
    docker:
      - image: circleci/node:13.8.0
    steps:
      - checkout
      - run: |
          npm install
          npm audit 
          npm run lint

  Create-db-infrastructure:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
          aws-access-key-id: Access_key
          aws-secret-access-key: Secret_key
          aws-region: region

      - run:
          name: "Creating db on AWS"
          command: |
           aws cloudformation create-stack \
            --stack-name db-infrastructure \
            --template-body file://db-infrastructure.yml \
            --capabilities "CAPABILITY_IAM" "CAPABILITY_NAMED_IAM" \
            --region=us-east-1

      - run:
          name: "Getting deployed instance dns"
          command: |
           aws ec2 describe-instances \
            --filters Name=tag:Name,Values=web-server-db \
            --query "Reservations[].Instances[].PublicDnsName" \
            --region=$region | tee db_dns.txt
           
           echo ls
           ls -al
           ls -al .circleci
           cp db_dns.txt .circleci
           echo ls
           ls -al
           ls -al .circleci
      
      - save_cache:
          key: db_dns
          paths:
            - ./db_dns.txt


# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-workflow:
    jobs:
      - Lint-js-files
      - Create-db-infrastructure:
          requires:
            - Lint-js-files